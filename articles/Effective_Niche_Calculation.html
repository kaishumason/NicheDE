<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="nicheDE">
<title>Effective Niche Calculation • nicheDE</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Effective Niche Calculation">
<meta property="og:description" content="nicheDE">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-inverse navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">nicheDE</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">Home</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/Tutorial.html">Tutorial</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Documentation</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Kmason23/NicheDE">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Effective Niche Calculation</h1>
            
      
      
      <div class="d-none name"><code>Effective_Niche_Calculation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="calculation-of-the-effective-niche">Calculation of the Effective Niche<a class="anchor" aria-label="anchor" href="#calculation-of-the-effective-niche"></a>
</h2>
<p>Calculating the effective niche for a given index cell consists of
three steps</p>
<ol style="list-style-type: decimal">
<li>Calculating the distance between the index cell and every other cell
in the sample</li>
<li>Transforming distances to kernel similarities using a gaussian
kernel with kernel bandwidth <span class="math inline">\(\sigma\)</span>
</li>
<li>Define the effective niche for niche cell <span class="math inline">\(n\)</span> as the sum of kernel similarities
between the index cell and cells of type <span class="math inline">\(n\)</span>
</li>
</ol>
<p>We can perform effective niche calculations using the function
‘CalculateEffectiveNiche’ which takes in two arguments</p>
<details><summary>
Arguments
</summary><ul>
<li>object: A niche-DE object</li>
<li>cutoff: The minimum kernel similarity allowable. Similarities below
this value are truncated to 0. Default value 0.05.</li>
</ul></details><pre><code><span><span class="va">NDE_obj</span> <span class="op">=</span> <span class="fu"><a href="../reference/CalculateEffectiveNiche.html">CalculateEffectiveNiche</a></span><span class="op">(</span><span class="va">NDE_obj</span><span class="op">)</span></span></code></pre>
<details><summary>
Suggestions on choice of kernel bandwidth
</summary><p>Choosing a reasonable sigma vector is critical to generating robust
and interpretable results.Sigma essentially determines what range of
neighboring spots contribute towards the effective niche. Small values
of sigma ensure that only close neighboring spots are considered while
large values of sigma result in effective niches that are smooth across
large regions of the tissue.<br>
To see what this looks like, I will generate a grid of values and show
what spots contribute to the effective niche of the middle spot. The
size of the spot corresponds to its relative importance. Below is a plot
of the spatial coordinates of the grid with the middle spot colored
red.</p>
<details><summary>
Code for generating coordinate plot
</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="co">#generate coordiantes</span></span>
<span><span class="va">coord</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">coord</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'x'</span>,<span class="st">'y'</span><span class="op">)</span></span>
<span><span class="co">#get distance matrix</span></span>
<span><span class="va">D</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="va">coord</span>,method <span class="op">=</span> <span class="st">'euclidean'</span>,diag <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#extract center distances</span></span>
<span><span class="va">D</span> <span class="op">=</span> <span class="va">D</span><span class="op">[</span><span class="fl">190</span>,<span class="op">]</span></span>
<span><span class="co">#make center circle red to distinguish </span></span>
<span><span class="va">red</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'black'</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">red</span><span class="op">[</span><span class="fl">190</span><span class="op">]</span> <span class="op">=</span> <span class="st">'red'</span></span>
<span><span class="co">#make dataframe</span></span>
<span><span class="va">coord</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">coord</span>,<span class="va">D</span>,<span class="va">red</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">coord</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,color <span class="op">=</span> <span class="va">red</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span><span class="va">red</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<img src="Effective_Niche_Calculation_files/figure-html/unnamed-chunk-2-1.png" width="700"></details><p>We first see what happens if the kernel bandwidth is very small. We
see that the only spot that contributes to the effective niche is the
middle spot itself. This may be appropriate if the spot can contain many
cells like in Visium data.<br></p>
<details><summary>
Code for generating plot with small sigma
</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#input your own sigma value</span></span>
<span><span class="va">sigma</span> <span class="op">=</span> <span class="fl">0.001</span></span>
<span><span class="co">#compute kernel similarities</span></span>
<span><span class="va">coord_sigma_small</span> <span class="op">=</span> <span class="va">coord</span></span>
<span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#make small similarities 0</span></span>
<span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span><span class="op">[</span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span><span class="op">&lt;</span><span class="fl">0.05</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="co">#plot similarities (size of dot = bigger similarity)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">coord_sigma_small</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,size<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">D</span><span class="op">==</span><span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">D</span><span class="op">)</span>,color <span class="op">=</span> <span class="va">red</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span><span class="va">red</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 399 rows containing missing values (`geom_point()`).</span></span></code></pre></div>
<p><img src="Effective_Niche_Calculation_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</details><p>We now see what happens if the kernel bandwidth is equivalent to the
distance between neighboring spots. We see that neighboring spots now
also contribute to the effective niche. This value may be appropriate if
we believe that niche patterns only depend on the closest neighbors of a
spot.<br></p>
<details><summary>
Code for generating plot with medium sigma
</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#input your own sigma value</span></span>
<span><span class="va">sigma</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="co">#compute kernel similarities</span></span>
<span><span class="va">coord_sigma_small</span> <span class="op">=</span> <span class="va">coord</span></span>
<span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#make small similarities 0</span></span>
<span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span><span class="op">[</span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span><span class="op">&lt;</span><span class="fl">0.05</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="co">#plot similarities (size of dot = bigger similarity)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">coord_sigma_small</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,size<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">D</span><span class="op">==</span><span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">D</span><span class="op">)</span>,color <span class="op">=</span> <span class="va">red</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span><span class="va">red</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 391 rows containing missing values (`geom_point()`).</span></span></code></pre></div>
<p><img src="Effective_Niche_Calculation_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
</details><p>We now see what happens if the kernel bandwidth is large, say 1/4th
of the length of the tissue. Many spots now contribute to the effective
niche. Additionally,it looks as though there is nearly equal
contribution for many cells near the center. This value may be
appropriate if we believe that niche patterns only depend on tissue
level patterns in niche.<br></p>
<details><summary>
Code for generating plot with large sigma
</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#input your own sigma value</span></span>
<span><span class="va">sigma</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="co">#compute kernel similarities</span></span>
<span><span class="va">coord_sigma_small</span> <span class="op">=</span> <span class="va">coord</span></span>
<span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span><span class="op">^</span><span class="fl">2</span><span class="op">/</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#make small similarities 0</span></span>
<span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span><span class="op">[</span><span class="va">coord_sigma_small</span><span class="op">$</span><span class="va">D</span><span class="op">&lt;</span><span class="fl">0.05</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="co">#plot similarities (size of dot = bigger similarity)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">coord_sigma_small</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,size<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">D</span><span class="op">==</span><span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">D</span><span class="op">)</span>,color <span class="op">=</span> <span class="va">red</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span><span class="va">red</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<img src="Effective_Niche_Calculation_files/figure-html/unnamed-chunk-5-1.png" width="700"></details><p>Clearly the choice of sigma can affect what niche patterns you will
find. For spot data which can contain many cells like Visium, we
recommend using a sigma vector that contains a small value, a value
equal to the distance between neighboring spots, and a value somewhat
larger, say 2-3 times the distance between neighboring spots.</p>
</details>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Kaishu Mason.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
